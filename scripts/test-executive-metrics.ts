/**
 * Test Executive Metrics with Existing Usage Data
 * This script validates that our executive metrics calculations work with real data
 */

import { executiveMetricsService } from '../lib/services/executive-metrics.service';
import { predictiveAnalyticsService } from '../lib/services/predictive-analytics.service';
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function testExecutiveMetrics() {
  console.log('‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó');
  console.log('‚ïë        EXECUTIVE METRICS TEST - REAL DATA VALIDATION              ‚ïë');
  console.log('‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù\n');

  try {
    // Get user and organization
    const user = await prisma.user.findUnique({
      where: { email: 'victor@aicostguardian.com' },
      include: { organization: true }
    });

    if (!user || !user.organizationId) {
      console.log('‚ùå User or organization not found');
      return;
    }

    const organizationId = user.organizationId;

    // Get current usage stats
    const stats = await prisma.usageLog.aggregate({
      where: { organizationId },
      _count: true,
      _sum: { cost: true, totalTokens: true }
    });

    console.log('üìä Current Usage Data:');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    console.log(`   Usage Records: ${stats._count}`);
    console.log(`   Total Cost: $${(stats._sum.cost || 0).toFixed(2)}`);
    console.log(`   Total Tokens: ${(stats._sum.totalTokens || 0).toLocaleString()}\n`);

    // Test Executive Metrics Calculation
    console.log('üéØ EXECUTIVE METRICS:');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    
    const executiveMetrics = await executiveMetricsService.calculateExecutiveMetrics(organizationId);
    
    console.log(`   Efficiency Score: ${executiveMetrics.efficiency.toFixed(1)}%`);
    console.log(`   ‚îî‚îÄ ${getEfficiencyInterpretation(executiveMetrics.efficiency)}`);
    
    console.log(`   Risk Score: ${executiveMetrics.riskScore} (lower is better)`);
    console.log(`   ‚îî‚îÄ ${getRiskInterpretation(executiveMetrics.riskScore)}`);
    
    console.log(`   Forecast Accuracy: ${executiveMetrics.forecastAccuracy.toFixed(1)}%`);
    console.log(`   ‚îî‚îÄ ${getForecastInterpretation(executiveMetrics.forecastAccuracy)}`);
    
    console.log(`   Savings Opportunity: $${executiveMetrics.savingsOpportunity.toFixed(2)}/month`);
    console.log(`   ‚îî‚îÄ ${getSavingsInterpretation(executiveMetrics.savingsOpportunity)}`);
    
    console.log(`   Compliance Score: ${executiveMetrics.complianceScore}%`);
    console.log(`   ‚îî‚îÄ ${getComplianceInterpretation(executiveMetrics.complianceScore)}\n`);

    // Test Performance Metrics
    console.log('‚ö° PERFORMANCE METRICS:');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    
    const performanceMetrics = await executiveMetricsService.getPerformanceMetrics(organizationId);
    
    console.log(`   Response Time: ${performanceMetrics.responseTime}ms`);
    console.log(`   Availability: ${performanceMetrics.availability}%`);
    console.log(`   Error Rate: ${performanceMetrics.errorRate}%`);
    console.log(`   Throughput: ${performanceMetrics.throughput} requests/min\n`);

    // Test Predictive Analytics
    console.log('üîÆ PREDICTIVE ANALYTICS:');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    
    const forecasts = await predictiveAnalyticsService.generateCostForecast(organizationId, 7);
    
    console.log('   7-Day Cost Forecast:');
    for (const forecast of forecasts.slice(0, 3)) {
      console.log(`   ${forecast.date.toLocaleDateString()}: $${forecast.predictedCost.toFixed(2)} (¬±${((forecast.upperBound - forecast.lowerBound) / 2).toFixed(2)}) - ${forecast.confidence.toFixed(0)}% confidence`);
    }
    
    // Test Pattern Detection
    console.log('\nüìà DETECTED PATTERNS:');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    
    const patterns = await predictiveAnalyticsService.detectPatterns(organizationId, 30);
    
    if (patterns.length > 0) {
      for (const pattern of patterns.slice(0, 3)) {
        console.log(`   ${pattern.type.toUpperCase()}: ${pattern.description}`);
        if (pattern.recommendation) {
          console.log(`   ‚îî‚îÄ Recommendation: ${pattern.recommendation}`);
        }
      }
    } else {
      console.log('   No significant patterns detected (need more usage data)');
    }

    // Test Optimization Recommendations
    console.log('\nüí° OPTIMIZATION RECOMMENDATIONS:');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    
    const optimizations = await predictiveAnalyticsService.generateOptimizationRecommendations(organizationId);
    
    if (optimizations.length > 0) {
      for (const opt of optimizations.slice(0, 3)) {
        console.log(`   ${opt.provider.toUpperCase()}: Save $${opt.savingsPotential.toFixed(2)}/month`);
        console.log(`   ‚îî‚îÄ ${opt.recommendation}`);
      }
    } else {
      console.log('   No optimization opportunities found yet');
    }

    // Test Trend Data
    console.log('\nüìä TREND ANALYSIS (Last 7 Days):');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    
    const costTrend = await executiveMetricsService.getTrendData(organizationId, 'cost', 7);
    const efficiencyTrend = await executiveMetricsService.getTrendData(organizationId, 'efficiency', 7);
    
    console.log('   Cost Trend:');
    for (const day of costTrend.slice(-3)) {
      const changeIndicator = day.change > 0 ? '‚Üë' : day.change < 0 ? '‚Üì' : '‚Üí';
      console.log(`   ${day.period}: $${day.value.toFixed(2)} ${changeIndicator} ${Math.abs(day.change).toFixed(1)}%`);
    }
    
    console.log('\n   Efficiency Trend:');
    for (const day of efficiencyTrend.slice(-3)) {
      const changeIndicator = day.change > 0 ? '‚Üë' : day.change < 0 ? '‚Üì' : '‚Üí';
      console.log(`   ${day.period}: ${day.value.toFixed(1)}% ${changeIndicator} ${Math.abs(day.change).toFixed(1)}%`);
    }

    // Summary and Recommendations
    console.log('\n\nüéØ EXECUTIVE SUMMARY:');
    console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê');
    
    if (stats._count < 100) {
      console.log('‚ö†Ô∏è  LIMITED DATA: You have less than 100 usage records.');
      console.log('   Metrics will become more accurate with more usage data.');
      console.log('   Consider importing historical data or generating more usage.\n');
    }
    
    if (executiveMetrics.efficiency < 70) {
      console.log('‚ö†Ô∏è  EFFICIENCY ALERT: Your efficiency score is below 70%.');
      console.log('   Review optimization recommendations to improve cost efficiency.\n');
    }
    
    if (executiveMetrics.riskScore > 50) {
      console.log('‚ö†Ô∏è  RISK ALERT: Your risk score is above 50.');
      console.log('   Consider setting up budgets and diversifying AI providers.\n');
    }
    
    if (executiveMetrics.savingsOpportunity > 100) {
      console.log('üí∞ SAVINGS OPPORTUNITY: You could save over $100/month.');
      console.log('   Implement the optimization recommendations above.\n');
    }
    
    if (executiveMetrics.complianceScore < 80) {
      console.log('üìã COMPLIANCE: Your compliance score needs improvement.');
      console.log('   Configure budgets, alerts, and team collaboration features.\n');
    }
    
    console.log('‚úÖ Executive metrics are calculating correctly with your data!');
    console.log('   Dashboard will now show real-time calculated values.\n');

  } catch (error) {
    console.error('‚ùå Error testing executive metrics:', error);
  } finally {
    await prisma.$disconnect();
  }
}

// Helper functions for interpretation
function getEfficiencyInterpretation(score: number): string {
  if (score >= 90) return 'üåü Excellent - Industry leading efficiency';
  if (score >= 75) return '‚úÖ Good - Above average efficiency';
  if (score >= 60) return 'üìä Average - Room for improvement';
  if (score >= 40) return '‚ö†Ô∏è Below Average - Optimization needed';
  return '‚ùå Poor - Immediate action required';
}

function getRiskInterpretation(score: number): string {
  if (score <= 20) return 'üõ°Ô∏è Very Low Risk - Excellent control';
  if (score <= 40) return '‚úÖ Low Risk - Well managed';
  if (score <= 60) return 'üìä Moderate Risk - Monitor closely';
  if (score <= 80) return '‚ö†Ô∏è High Risk - Action needed';
  return '‚ùå Critical Risk - Immediate intervention required';
}

function getForecastInterpretation(accuracy: number): string {
  if (accuracy >= 90) return 'üéØ Highly Accurate - Very reliable predictions';
  if (accuracy >= 75) return '‚úÖ Good Accuracy - Reliable for planning';
  if (accuracy >= 60) return 'üìä Moderate Accuracy - Use with caution';
  if (accuracy >= 40) return '‚ö†Ô∏è Low Accuracy - Need more data';
  return '‚ùå Insufficient Data - Cannot predict reliably';
}

function getSavingsInterpretation(savings: number): string {
  if (savings >= 500) return 'üíé Major Savings - Significant optimization potential';
  if (savings >= 200) return 'üí∞ Good Savings - Worth implementing';
  if (savings >= 50) return 'üíµ Moderate Savings - Consider optimizing';
  if (savings >= 10) return 'üí∏ Minor Savings - Low priority';
  return '‚úÖ Optimized - Already efficient';
}

function getComplianceInterpretation(score: number): string {
  if (score >= 95) return 'üèÜ Excellent - Full compliance';
  if (score >= 80) return '‚úÖ Good - Well configured';
  if (score >= 60) return 'üìä Adequate - Some gaps';
  if (score >= 40) return '‚ö†Ô∏è Poor - Many gaps to address';
  return '‚ùå Critical - Immediate setup required';
}

// Run the test
testExecutiveMetrics()
  .then(() => console.log('‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê'))
  .catch(console.error);